<html layout:decorate="~{layout_for_main_notice_qna}" xmlns:th="http://www.thymeleaf.org">
<div layout:fragment="content" class="container my-3">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="/css/main/main.css" th:href="@{/css/main/main.css}" />

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

<div class="container mt-2 mb-2">
    <div class="row">
        <div class="col-md-6" >
            <h4 class="title" style="margin:20px;"><svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M416 0C400 0 288 32 288 176V288c0 35.3 28.7 64 64 64h32V480c0 17.7 14.3 32 32 32s32-14.3 32-32V352 240 32c0-17.7-14.3-32-32-32zM64 16C64 7.8 57.9 1 49.7 .1S34.2 4.6 32.4 12.5L2.1 148.8C.7 155.1 0 161.5 0 167.9c0 45.9 35.1 83.6 80 87.7V480c0 17.7 14.3 32 32 32s32-14.3 32-32V255.6c44.9-4.1 80-41.8 80-87.7c0-6.4-.7-12.8-2.1-19.1L191.6 12.5c-1.8-8-9.3-13.3-17.4-12.4S160 7.8 160 16V150.2c0 5.4-4.4 9.8-9.8 9.8c-5.1 0-9.3-3.9-9.8-9L127.9 14.6C127.2 6.3 120.3 0 112 0s-15.2 6.3-15.9 14.6L83.7 151c-.5 5.1-4.7 9-9.8 9c-5.4 0-9.8-4.4-9.8-9.8V16zm48.3 152l-.3 0-.3 0 .3-.7 .3 .7z"/></svg> 오늘의 Best 5 음식점</h4>
            <div th:each="eatjjim,  idx :${eatjjim}" class="card p-2 mb-2">
                <div class="p-4">
                    <div class="badge" style="display: inline-block; ">
                        <span th:text="'Best ' + (${idx.index + 1})">Best</span>
                    </div>
                    <h5 class="heading" th:text="${eatjjim.hotplace_name}" th:attr="data-hotplace-no=${eatjjim.hotplace_no}" style="display: inline-block;"></h5>
                    <div class="c-details mt-3">
                        <span th:text="${eatjjim.address}"></span>
                    </div>
                    <div class="mt-3">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" th:style="'width: ' + ${eatjjim.avg_emo_result} + '%'" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="mt-3">
                            <span class="text1" th:text="'리뷰 온도 ' + ${eatjjim.avg_emo_result}+'°C'" style="float: left;"></span>
                            <span class="text2" th:text="'오늘의 저장수 ' + ${eatjjim.jjim}" style="float: right;"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <h4 class="title" style="margin:20px;"><svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M88 0C74.7 0 64 10.7 64 24c0 38.9 23.4 59.4 39.1 73.1l1.1 1C120.5 112.3 128 119.9 128 136c0 13.3 10.7 24 24 24s24-10.7 24-24c0-38.9-23.4-59.4-39.1-73.1l-1.1-1C119.5 47.7 112 40.1 112 24c0-13.3-10.7-24-24-24zM32 192c-17.7 0-32 14.3-32 32V416c0 53 43 96 96 96H288c53 0 96-43 96-96h16c61.9 0 112-50.1 112-112s-50.1-112-112-112H352 32zm352 64h16c26.5 0 48 21.5 48 48s-21.5 48-48 48H384V256zM224 24c0-13.3-10.7-24-24-24s-24 10.7-24 24c0 38.9 23.4 59.4 39.1 73.1l1.1 1C232.5 112.3 240 119.9 240 136c0 13.3 10.7 24 24 24s24-10.7 24-24c0-38.9-23.4-59.4-39.1-73.1l-1.1-1C231.5 47.7 224 40.1 224 24z"/></svg> 오늘의 Best 5 카페</h4>
            <div th:each="cafejjim,  idx :${cafejjim}" class="card p-2 mb-2">
                <div class="p-4">
                    <div class="badge" style="display: inline-block;">
                        <span th:text="'Best ' + (${idx.index + 1})">Best</span>
                    </div>
                    <h5 class="heading" th:text="${cafejjim.hotplace_name}" th:attr="data-hotplace-no=${cafejjim.hotplace_no}" style="display: inline-block;"></h5>
                    <div class="c-details mt-3">
                        <span th:text="${cafejjim.address}"></span>
                    </div>
                    <div class="mt-3">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" th:style="'width: ' + ${cafejjim.avg_emo_result} + '%'" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="mt-3">
                            <span class="text1" th:text="'리뷰 온도 ' + ${cafejjim.avg_emo_result}+'°C'" style="float: left;"></span>
                            <span class="text2" th:text="'오늘의 저장수 ' + ${cafejjim.jjim}" style="float: right;"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- 모달창 -->
    <div class="modal" tabindex="-1" id="myModal">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h5 class="modal-title">Review</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body">
                    <!-- 리뷰 및 감정 분석 결과가 여기에 추가됨-->
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button id="closeModal" type="button" class="btn btn-danger" data-bs-dismiss ="modal">Close</button>
                </div>

            </div>
        </div>
    </div>

<br/>
<br/>
<!-- 시도 select -->
<h4 class="title" style="margin-left:50px;"><svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M128 0c17.7 0 32 14.3 32 32V64H288V32c0-17.7 14.3-32 32-32s32 14.3 32 32V64h48c26.5 0 48 21.5 48 48v48H0V112C0 85.5 21.5 64 48 64H96V32c0-17.7 14.3-32 32-32zM0 192H448V464c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V192zm64 80v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V272c0-8.8-7.2-16-16-16H80c-8.8 0-16 7.2-16 16zm128 0v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V272c0-8.8-7.2-16-16-16H208c-8.8 0-16 7.2-16 16zm144-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V272c0-8.8-7.2-16-16-16H336zM64 400v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V400c0-8.8-7.2-16-16-16H80c-8.8 0-16 7.2-16 16zm144-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V400c0-8.8-7.2-16-16-16H208zm112 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V400c0-8.8-7.2-16-16-16H336c-8.8 0-16 7.2-16 16z"/></svg> 이번달 Best 5</h4>
<div class="container2 mt-1 mb-1">
    <div class="mx-2">
        <label for="sido" class="form-label">시/도</label>
    </div>
    <div class="mx-2">
        <select name="sido" id="sido" class="form-select">
            <option value="">선택하세요</option>
        </select>
    </div>
    <div class="mx-2">
        <label for="gugun" class="form-label">시/군/구</label>
    </div>
    <div class="mx-2">
        <select name="gugun" id="gugun" class="form-select">
            <option value="">선택하세요</option>
        </select>
    </div>
    <div class="mx-2">
        <label for="category" class="form-label">카테고리</label>
    </div>
    <div class="mx-2">
        <select name="category" id="category" class="form-select">
            <option value="">선택하세요</option>
            <option value="1">음식점</option>
            <option value="2">카페</option>
        </select>
    </div>
    <div class="mx-2">
        <button type="button" class="btn btn-outline-danger" id="sendButton">검색</button>
    </div>
</div>

<!--월별 Best 자바스크립트에서 처리-->
<div id="result" class="card p-2 mb-2" style="padding: 30px;">
    <div class="mx-3" style="padding: 30px;">
        <div class="badge" style="display: inline-block; margin-right: 10px;">
            <span>순위</span>
        </div>
        <h6 class="heading" style="display: inline-block;">가게이름</h6>
        <div class="ms-2 c-details">
            <span class="mb-0"></span>
        </div>
        <div class="mt-3" style="width: 50%;">
            <div class="progress2">
                <div class="progress2-bar justify-content-center" role="progressbar" th:style="'width: ' + 리뷰온도 + '%'" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="mt-3">
                <span class="text1" th:text="'리뷰온도 ' + 리뷰온도" style="float: left;"></span>
                <span class="text2" th:text="'찜수 ' + 찜수" style="float: right;"></span>
            </div>
        </div>
    </div>
</div>
</div>


</html>

<!-- 자바스크립트 -->
<script layout:fragment="script">
document.addEventListener("DOMContentLoaded", function () {
   // 모달창 생성
  var modal = document.createElement('div');
  modal.id = 'myModal';
  modal.className = 'modal fade';
  modal.tabIndex = '-1';

  var dialog = document.createElement('div');
  dialog.className = 'modal-dialog';

  var content = document.createElement('div');
  content.className = 'modal-content';

  // 모달 헤더 생성
  var header= document.createElement('div');
  header.className= 'modal-header';

  var title= document.createElement('h5');
  title.className= 'modal-title';
  title.textContent='Review';

  var closeButtonHeader= document.createElement('button');
  closeButtonHeader.type='button';
  closeButtonHeader.className='btn-close';
  closeButtonHeader.setAttribute("data-bs-dismiss", "modal");

  header.appendChild(title);
  header.appendChild(closeButtonHeader);

  content.appendChild(header);

  //모달 바디 생성
  var body = document.createElement('div');
  body.className = 'modal-body';

  content.appendChild(body);
  dialog.appendChild(content);
  modal.appendChild(dialog);

  // 모달창을 body에 추가
  document.body.appendChild(modal);

  //모달 푸터 생성
  var footer=document.createElement('div');
  footer.className='modal-footer';

  let closeModalButton=document.createElement('button')
  closeModalButton.id="closeModal";
  closeModalButton.type="button";
  closeModalButton.className="btn btn-danger";
  closeModalButton.setAttribute("data-bs-dismiss", "modal");
  closeModalButton.textContent = 'Close';

  footer.appendChild(closeModalButton);
  content.appendChild(footer);

   document.querySelectorAll('.heading').forEach(function (element) {
       element.addEventListener("click", function () {
           var hotplace_no = this.getAttribute('data-hotplace-no');
           var url = '/review/' + hotplace_no;

           var xhr = new XMLHttpRequest();
           xhr.open('GET', url, true);
           xhr.setRequestHeader('Content-Type', 'application/json');

           xhr.onreadystatechange = function () {
               if (xhr.readyState === 4) {
                   if (xhr.status === 200) {
                       var data = JSON.parse(xhr.responseText);

                      console.log(data);

                      // AJAX 요청이 성공적으로 완료된 후에만 모달 창 열기
                      var reviewModalElm = document.getElementById('myModal');
                      if (reviewModalElm != null) {
                        let modalBody = reviewModalElm.querySelector('.modal-body');
                        modalBody.innerHTML = '';

                        data.forEach(function(reviewList) {
                            let reviewBody = document.createElement('div');
                            reviewBody.classList.add('modalReviewCard', 'my-2');
                            //reviewBody.style.box-shadow = '0 4px 8px rgba(0, 0, 0, 0.2)';//그림자효과
                          let reviewTextElement = document.createElement('p');
                          reviewTextElement.textContent = reviewList.review;

                          let emoResultElement = document.createElement('p');
                          emoResultElement.style.textAlign = 'right';
                          emoResultElement.textContent ='리뷰 온도 '+reviewList.emo_result+'°C';
                          emoResultElement.classList.add('text1');
                            reviewBody.appendChild(reviewTextElement);
                            reviewBody.appendChild(emoResultElement);

                          modalBody.appendChild(reviewBody);
                        });

                         var modalInstance= new bootstrap.Modal(reviewModalElm);
                         modalInstance.show();
                      }

                   } else { // 요청 실패 시 처리
                       alert('요청 실패: ' + xhr.status);
                   }
               }
           };

           xhr.send();
       });
   });
});
</script>
<script layout:fragment="script">
document.addEventListener("DOMContentLoaded", function () {
    var resultDiv = document.getElementById("result");
    resultDiv.style.display = "none"; // 페이지 로드 시 결과 숨기기

    // 페이지 로드 시 초기 데이터를 가져와서 선택 상자를 생성하는 부분
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "http://localhost/initialData", true);
    xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

      // 모달창 생성
  var modal = document.createElement('div');
  modal.id = 'myModal';
  modal.className = 'modal fade';
  modal.tabIndex = '-1';

  var dialog = document.createElement('div');
  dialog.className = 'modal-dialog';

  var content = document.createElement('div');
  content.className = 'modal-content';

  // 모달 헤더 생성
  var header= document.createElement('div');
  header.className= 'modal-header';

  var title= document.createElement('h5');
  title.className= 'modal-title';
  title.textContent='Review';

  var closeButtonHeader= document.createElement('button');
  closeButtonHeader.type='button';
  closeButtonHeader.className='btn-close';
  closeButtonHeader.setAttribute("data-bs-dismiss", "modal");

  header.appendChild(title);
  header.appendChild(closeButtonHeader);

  content.appendChild(header);

  //모달 바디 생성
  var body = document.createElement('div');
  body.className = 'modal-body';

  content.appendChild(body);
  dialog.appendChild(content);
  modal.appendChild(dialog);

  // 모달창을 body에 추가
  document.body.appendChild(modal);

  //모달 푸터 생성
  var footer=document.createElement('div');
  footer.className='modal-footer';

  let closeModalButton=document.createElement('button')
  closeModalButton.id="closeModal";
  closeModalButton.type="button";
  closeModalButton.className="btn btn-danger";
  closeModalButton.setAttribute("data-bs-dismiss", "modal");
  closeModalButton.textContent = 'Close';

  footer.appendChild(closeModalButton);
  content.appendChild(footer);

    xhr.onload = function () {
        if (xhr.status === 200) {
            try {
                var response = JSON.parse(xhr.responseText);
                console.log(response);

                var sidoSelect = document.getElementById("sido");
                var gugunSelect = document.getElementById("gugun");

               // JSON 객체를 가나다순으로 정렬
                var sortedResponse = {};
                Object.keys(response).sort().forEach(function(key) {
                    sortedResponse[key] = response[key];
                });

                // 가나다순으로 정렬된 JSON 객체를 사용하여 시도 목록 초기화
                for (var sido in sortedResponse) {
                    var option = document.createElement("option");
                    option.value = sido;
                    option.textContent = sido;
                    sidoSelect.appendChild(option);
                }

                // 초기 시/도 선택
                sidoSelect.addEventListener("change", function () {
                    var selectedSido = this.value; // 선택한 시/도 값을 가져옴
                    var gugunArr = response[selectedSido];

                    // 구군 목록 초기화
                    gugunSelect.innerHTML = '<option value="">선택하세요</option>';
                    if (gugunArr) {
                        for (var i = 0; i < gugunArr.length; i++) {
                            var option = document.createElement("option");
                            option.value = gugunArr[i];
                            option.textContent = gugunArr[i];
                            gugunSelect.appendChild(option);
                        }
                    }
                });

                // 초기 시/도 선택
                sidoSelect.dispatchEvent(new Event("change"));
            } catch (error) {
                console.error("JSON 파싱 오류:", error);
            }

        } else {
            console.log("Error:", xhr.statusText);
            alert("Error:" + xhr.statusText);
        }
    };

    xhr.onerror = function () {
        console.log("Network Error");
        alert("Network Error");
    };

    xhr.send();

    // 검색 버튼 클릭 시 실행되는 부분
    var sendButton = document.getElementById("sendButton");
    sendButton.addEventListener("click", function () {
        var selectedSido = document.getElementById("sido").value; //선택한 시도값
        var selectedGugun = document.getElementById("gugun").value; //선택한 구군값
        var selectedCategory = parseInt(document.getElementById("category").value); //선택한 카테고리 값
        var resultDiv = document.getElementById("result");

        if (selectedSido === "" || selectedGugun === "" || isNaN(selectedCategory)) {
            // 사용자가 조건을 선택하지 않은 경우 결과를 숨김
            resultDiv.style.display = "none";
            alert("시도, 시군구, 카테고리를 모두 선택해주세요.");
        } else {
            // 선택한 조건에 따라 결과를 표시
            resultDiv.style.display = "block";

            // 이후 검색과 관련된 로직을 수행
            var formData = new FormData();
            formData.append("sido", selectedSido);
            formData.append("gugun", selectedGugun);
            formData.append("hotplace_cate_no", selectedCategory);

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "http://localhost/main", true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded;charset=UTF-8");

            xhr.onload = function () {
                if (xhr.status === 200) {
                    try {
                        var response = JSON.parse(xhr.responseText);
                        console.log(response);

                        // 여기서 response 객체를 활용하여 필요한 처리를 수행
                        // 테이블 업데이트 코드 추가
                        var resultDiv = document.getElementById("result");
                        resultDiv.innerHTML = ""; // 기존 데이터 삭제

                        if (response.monthBestList.length === 0) {
                            // 결과가 없을 때 메시지를 표시
                            var noDataMessage = document.createElement("p");
                            noDataMessage.textContent = "이번달에 저장된 가게가 없습니다.";
                            resultDiv.appendChild(noDataMessage);
                        } else {
                            // 결과가 있을 때 카드에 데이터 추가
    for (var i = 0; i < response.monthBestList.length; i++) {
        var entry = response.monthBestList[i];

        // 카드를 생성하여 데이터 표시
        var card = document.createElement("div");
        card.className = "card p-2 mb-2";

        var cardContent = document.createElement("div");
        cardContent.className = "mt-1";
        cardContent.style.padding = "15px";

        // 순위를 표시하는 열 추가
        var rankBadge = document.createElement("div");
        rankBadge.className = "badge";
        rankBadge.style.display = "inline-block";
        rankBadge.style.marginRight = "10px";
        rankBadge.textContent = "순위";
        rankBadge.style.marginBottom = "10px";

        var rankSpan = document.createElement("span");
        rankSpan.textContent = "Best " + (i + 1); // 순위 계산 (0부터 시작하므로 +1)

        rankBadge.appendChild(rankSpan);

        // 가게 이름을 표시하는 열 추가
        var nameH6 = document.createElement("h5");
        nameH6.className = "heading2";
        nameH6.style.display = "inline-block";
        nameH6.textContent = entry.hotplace_name;
        nameH6.setAttribute("th:text", "'${monthBestList.hotplace_name}'");
        nameH6.setAttribute("th:attr", "'data-hotplace-no=' + ${monthBestList.hotplace_no}");
        nameH6.style.marginBottom = "10px"; // 상하 마진

        // 가게 주소를 표시하는 열 추가
        var addressDiv = document.createElement("div");
        addressDiv.className = "ms-2 c-details";

        var addressSpan = document.createElement("span");
        addressSpan.className = "mb-0";
        addressSpan.textContent = entry.address; // monthBestList의 주소 정보를 표시
        addressDiv.appendChild(addressSpan);

        // 리뷰 온도를 표시하는 열 추가
        var reviewProgress = document.createElement("div");
        reviewProgress.className = "progress";
        reviewProgress.style.marginTop = "10px";

        var reviewProgressBar = document.createElement("div");
        reviewProgressBar.className = "progress-bar";
        reviewProgressBar.role = "progressbar";
        reviewProgressBar.style.width = entry.avg_emo_result + "%"; //리뷰 온도 값 사용

        reviewProgress.appendChild(reviewProgressBar);

        var reviewText1 = document.createElement("span");
        reviewText1.className = "text1";
        reviewText1.textContent = "리뷰 온도 " + entry.avg_emo_result + "°C";
        reviewText1.style.float = "left";
        reviewText1.style.marginTop = "15px";

        // 찜 수를 표시하는 열 추가
        var jjimText2 = document.createElement("span");
        jjimText2.className = "text2";
        jjimText2.textContent = "이번달 저장수 " + entry.jjim;
        jjimText2.style.float = "right";
        jjimText2.style.marginTop = "15px";

        cardContent.appendChild(rankBadge);
        cardContent.appendChild(nameH6);
        cardContent.appendChild(addressDiv);
        cardContent.appendChild(reviewProgress);
        cardContent.appendChild(reviewText1);
        cardContent.appendChild(jjimText2);

        card.appendChild(cardContent);

        // 결과 테이블에 카드 추가
        resultDiv.appendChild(card);

        // 마지막 리스트에는 수평선을 추가하지 않음
        if (i < response.monthBestList.length - 1) {
            var horizontalLine = document.createElement("hr");
            resultDiv.appendChild(horizontalLine);




                                }
                            }



                        }
                    } catch (error) {
                        console.error("JSON 파싱 오류:", error);
                    }
                } else {
                    console.log("Error:", xhr.statusText);
                    alert("Error" + xhr.statusText);
                }
            };

            xhr.onerror = function () {
                console.log("Network Error");
                alert("Network Error");
            };
            xhr.send("sido=" + selectedSido + "&gugun=" + selectedGugun + "&hotplace_cate_no=" + selectedCategory); //매개변수를 전달
        }
    });
});

</script>
